# DESARROLLO DE FUNCIONALIDAD DE INSCRIPCIÃ“N

## ğŸ“‹ DESCRIPCIÃ“N GENERAL
Esta funcionalidad permite a los usuarios inscribirse en fulbitos cuando se abre el perÃ­odo de inscripciÃ³n. El sistema maneja timing, capacidad, suplentes y sincronizaciÃ³n automÃ¡tica sin WebSockets.

## ğŸ¯ OBJETIVOS PRINCIPALES
- Permitir inscripciÃ³n automÃ¡tica cuando se abre el perÃ­odo
- Manejar capacidad limitada (ej: 10 jugadores)
- Gestionar suplentes cuando se llena la capacidad
- SincronizaciÃ³n automÃ¡tica con el servidor
- UI intuitiva y responsive

## ğŸ”§ APIS REQUERIDAS

### 1. API de Estado de InscripciÃ³n (FUSIONADA)
**GET /api/auth/fulbito/{id}/registrations/**

```json
{
  "status": "success",
  "data": {
    "fulbito_id": 3,
    "registration_open": false,
    "opens_at": "2024-09-21T22:00:00Z",
    "current_time": "2024-09-19T15:30:00Z",
    "time_until_open": "2 days, 6 hours, 30 minutes",
    "capacity": 10,
    "registered_count": 0,
    "can_register": false,
    "players": [
      {
        "id": 1,
        "username": "jugador1",
        "phone": "+5493812345678",
        "photo_url": "/media/photo1.jpg",
        "registered_at": "2024-09-21T22:00:15Z",
        "position": 1,
        "averageSkills": {
          "speed": 75,
          "passing": 60,
          "stamina": 80,
          "shooting": 70,
          "dribbling": 65,
          "defending": 55
        }
      }
    ],
    "spots_available": 10,
    "is_user_registered": false,
    "user_position": null
  }
}
```

### 2. API de InscripciÃ³n
**POST /api/auth/fulbito/{id}/register/**

```json
{
  "status": "success",
  "data": {
    "registration_id": 123,
    "position": 5,
    "registered_at": "2024-09-21T22:00:15Z",
    "message": "InscripciÃ³n exitosa"
  }
}
```

### 3. API de Home (ACTUALIZADA)
**GET /api/auth/invitation/all/**

```json
{
  "status": "success",
  "data": {
    "nearby_fulbito_seconds": 7200,  // NUEVO CAMPO
    "fulbitos": {
      "my_fulbitos": [
        {
          "id": 3,
          "name": "Veteranos 47",
          "registration_status": {  // NUEVOS CAMPOS
            "is_open": false,
            "opens_at": "2024-09-21T22:00:00Z",
            "registered_count": 3,
            "capacity": 10,
            "can_register": false,
            "is_user_registered": false,
            "user_position": null
          }
        }
      ]
    }
  }
}
```

## ğŸ¨ INTERFAZ GRÃFICA

### Pantalla de InscripciÃ³n (PestaÃ±a 3 del FulbitoDetailsScreen)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… InscripciÃ³n: Martes 23 Sep 20:00 â”‚
â”‚ âœ… InscripciÃ³n ABIERTA              â”‚
â”‚                                     â”‚
â”‚ ğŸ‘¥ Jugadores inscritos (3/10):      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¥‡ 1. Juan PÃ©rez   22:00:15    â”‚ â”‚
â”‚ â”‚ ğŸ¥ˆ 2. MarÃ­a LÃ³pez  22:00:23    â”‚ â”‚
â”‚ â”‚ ğŸ¥‰ 3. Carlos Ruiz  22:00:31    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [ğŸ“ INSCRIBIRME]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estados de la UI

#### 1. InscripciÃ³n Cerrada
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… InscripciÃ³n: Martes 23 Sep 20:00 â”‚
â”‚ ğŸ”´ InscripciÃ³n CERRADA              â”‚
â”‚                                     â”‚
â”‚ â° Se abre en: 2 dÃ­as, 6 horas      â”‚
â”‚                                     â”‚
â”‚ ğŸ‘¥ Jugadores inscritos (0/10):       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚        (Lista vacÃ­a)            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [ğŸš« INSCRIPCIÃ“N NO DISPONIBLE]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. InscripciÃ³n Abierta
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… InscripciÃ³n: Martes 23 Sep 20:00 â”‚
â”‚ âœ… InscripciÃ³n ABIERTA              â”‚
â”‚                                     â”‚
â”‚ ğŸ‘¥ Jugadores inscritos (3/10):       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¥‡ 1. Juan PÃ©rez   22:00:15    â”‚ â”‚
â”‚ â”‚ ğŸ¥ˆ 2. MarÃ­a LÃ³pez  22:00:23    â”‚ â”‚
â”‚ â”‚ ğŸ¥‰ 3. Carlos Ruiz  22:00:31    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [ğŸ“ INSCRIBIRME]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Usuario Ya Inscrito
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… InscripciÃ³n: Martes 23 Sep 20:00 â”‚
â”‚ âœ… InscripciÃ³n ABIERTA              â”‚
â”‚                                     â”‚
â”‚ ğŸ‘¥ Jugadores inscritos (3/10):       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ¥‡ 1. Juan PÃ©rez   22:00:15    â”‚ â”‚
â”‚ â”‚ ğŸ¥ˆ 2. MarÃ­a LÃ³pez  22:00:23    â”‚ â”‚
â”‚ â”‚ ğŸ¥‰ 3. Carlos Ruiz  22:00:31    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ âœ… YA ESTÃS INSCRITO (#3)           â”‚
â”‚ [âŒ CANCELAR INSCRIPCIÃ“N]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ LÃ“GICA DE TIMING

### Campo `nearby_fulbito_seconds`
- **UbicaciÃ³n**: RaÃ­z de la respuesta de `/api/auth/invitation/all/`
- **Valor**: Segundos hasta la prÃ³xima apertura de inscripciÃ³n
- **Ejemplo**: `7200` = 2 horas, `300` = 5 minutos

### Estrategia de SincronizaciÃ³n

#### 1. Estado Inicial
```
API responde: nearby_fulbito_seconds: 7200 (2 horas)
App: "Falta mucho, no hago nada especial"
```

#### 2. Se Acerca el Momento (â‰¤ 10 minutos)
```
API responde: nearby_fulbito_seconds: 480 (8 minutos)
App: "Programo consulta en 475 segundos"
```

#### 3. Ãšltimos Segundos (â‰¤ 20 segundos)
```
API responde: nearby_fulbito_seconds: 15 (15 segundos)
App: "Programo consulta en 14 segundos"
```

#### 4. Se Abre la InscripciÃ³n
```
API responde: nearby_fulbito_seconds: 0
App: "Â¡InscripciÃ³n abierta! Actualizo UI y badges"
```

## ğŸ  BADGES EN EL HOME

### Badge de Estado
- ğŸ”´ **"InscripciÃ³n cerrada"** - cuando `registration_status.is_open = false`
- ğŸŸ¡ **"Se abre en 2h"** - cuando estÃ¡ cerca de abrir
- ğŸŸ¢ **"InscripciÃ³n abierta"** - cuando `registration_status.is_open = true`
- âœ… **"Ya inscrito #3"** - cuando `registration_status.is_user_registered = true`

### Badge de Capacidad
- **"3/10"** - mostrando `registered_count/capacity`

## ğŸ”„ FLUJO DE LA APLICACIÃ“N

### 1. En el Home
- **API**: `/api/auth/invitation/all/` (con campos de inscripciÃ³n)
- **Muestra**: Badges de estado y capacidad
- **AcciÃ³n**: Click en icono "i" â†’ va a detalles

### 2. En Detalles del Fulbito
- **API**: `/api/auth/fulbito/{id}/registrations/` (completa)
- **Muestra**: Lista completa de inscritos con habilidades
- **AcciÃ³n**: BotÃ³n inscribirse si estÃ¡ disponible

### 3. Al Inscribirse
- **API**: `POST /api/auth/fulbito/{id}/register/`
- **ActualizaciÃ³n**: Recargar la API de registrations

## ğŸ¯ CASOS DE USO

### Caso 1: InscripciÃ³n Normal
1. Usuario ve fulbito en home
2. Click en icono "i" â†’ va a detalles
3. PestaÃ±a "InscripciÃ³n" muestra estado
4. Click "INSCRIBIRME" â†’ se inscribe
5. UI se actualiza automÃ¡ticamente

### Caso 2: Capacidad Llena
1. Usuario intenta inscribirse
2. Sistema verifica capacidad
3. Si estÃ¡ llena â†’ va a lista de suplentes
4. Si hay espacio â†’ se inscribe normalmente

### Caso 3: Timing AutomÃ¡tico
1. App consulta API cada vez que va al home
2. Cuando `nearby_fulbito_seconds â‰¤ 600` â†’ activa timer
3. Timer programa consulta automÃ¡tica
4. UI se actualiza cuando se abre la inscripciÃ³n

## ğŸš¨ MANEJO DE ERRORES

### 1. Fallos de API
- **Reintentar** en 30 segundos
- **Mostrar mensaje** de error al usuario
- **Mantener estado** anterior

### 2. PÃ©rdida de ConexiÃ³n
- **Pausar timers** cuando no hay conexiÃ³n
- **Reactivar** cuando vuelve la conexiÃ³n
- **Sincronizar** con el servidor

### 3. Cambios de Timing
- **Recalcular** automÃ¡ticamente
- **Actualizar** UI en tiempo real
- **Notificar** al usuario

## ğŸ“± CONSIDERACIONES MÃ“VILES

### 1. Background/Foreground
- **Pausar timers** cuando app estÃ¡ en background
- **Reactivar** cuando vuelve a foreground
- **Sincronizar** con servidor

### 2. Notificaciones
- **Push notifications** cuando se abre inscripciÃ³n
- **Badges** en el icono de la app
- **Sonidos** opcionales

### 3. OptimizaciÃ³n de BaterÃ­a
- **Timers eficientes** solo cuando es necesario
- **Cancelar timers** cuando no se necesita
- **SincronizaciÃ³n inteligente**

## ğŸ”§ IMPLEMENTACIÃ“N TÃ‰CNICA

### HomeProvider
```dart
class HomeProvider {
  Timer? _registrationTimer;
  int? _nearbyFulbitoSeconds;
  
  void _handleNearbyFulbitoSeconds(int seconds) {
    if (seconds <= 600) {  // 10 minutos
      _scheduleNextCheck(seconds - 5);
    } else if (seconds <= 20) {  // 20 segundos
      _scheduleNextCheck(seconds - 1);
    }
  }
  
  void _scheduleNextCheck(int delaySeconds) {
    _registrationTimer?.cancel();
    _registrationTimer = Timer(Duration(seconds: delaySeconds), () {
      _refreshData(); // Vuelve a consultar la API
    });
  }
}
```

### FulbitoProvider
```dart
class FulbitoProvider {
  Future<void> loadRegistrationStatus(int fulbitoId) async {
    // Cargar estado de inscripciÃ³n
  }
  
  Future<bool> registerForFulbito(int fulbitoId) async {
    // Inscribirse en el fulbito
  }
  
  Future<void> cancelRegistration(int fulbitoId) async {
    // Cancelar inscripciÃ³n
  }
}
```

## ğŸ“‹ CHECKLIST DE DESARROLLO

### Backend
- [ ] Implementar API `/api/auth/fulbito/{id}/registrations/`
- [ ] Implementar API `POST /api/auth/fulbito/{id}/register/`
- [ ] Agregar campo `nearby_fulbito_seconds` a `/api/auth/invitation/all/`
- [ ] Agregar campos de `registration_status` a fulbitos
- [ ] Manejar capacidad y suplentes
- [ ] Implementar lÃ³gica de timing

### Frontend
- [ ] Crear pestaÃ±a "InscripciÃ³n" en FulbitoDetailsScreen
- [ ] Implementar UI de estados de inscripciÃ³n
- [ ] Agregar badges en HomeScreen
- [ ] Implementar lÃ³gica de timing en HomeProvider
- [ ] Manejar errores y estados de carga
- [ ] Implementar notificaciones

### Testing
- [ ] Probar timing automÃ¡tico
- [ ] Probar casos de capacidad llena
- [ ] Probar manejo de errores
- [ ] Probar sincronizaciÃ³n
- [ ] Probar casos edge

## ğŸ¯ PRÃ“XIMOS PASOS

1. **Implementar APIs** en el backend
2. **Crear UI** de inscripciÃ³n
3. **Implementar lÃ³gica** de timing
4. **Agregar badges** en home
5. **Testing** completo
6. **OptimizaciÃ³n** y pulido

---

**NOTA**: Este documento debe ser actualizado conforme se implemente la funcionalidad. Mantener sincronizado con el cÃ³digo real.
